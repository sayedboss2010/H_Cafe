@* @{
    ViewData["Title"] = "مسح QR";
}

<h2>مسح QR Code</h2>

<div id="reader" style="width:300px;"></div>
<p id="result">في انتظار المسح...</p>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('result').innerText = `✅ تم المسح: ${decodedText}`;

        // إرسال البيانات إلى الكنترولر عبر AJAX
        fetch('/Home/ReceiveQrData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({ qrData: decodedText })
        })
        .then(response => response.json())
        .then(data => {
            console.log("📩 تم الإرسال بنجاح:", data);
        })
        .catch(error => {
            console.error('❌ حدث خطأ:', error);
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
    );
</script>

<!-- للتأكد من أمان الطلبات POST -->
<form asp-controller="Home" asp-action="ReceiveQrData" method="post">
    @Html.AntiForgeryToken()
</form>
 *@

@{
    ViewData["Title"] = "إدخال QR يدوي";
}

<h2>📄 إدخال بيانات QR Code يدويًا</h2>

<form id="qrForm">
    @Html.AntiForgeryToken()

    <input type="text" id="qrInput" placeholder="أدخل نص QR هنا" style="width:300px; padding:10px;" />
    <button type="submit">إرسال</button>
</form>

<p id="response"></p>

<script>
       document.getElementById("qrForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const qrValue = document.getElementById("qrInput").value;
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch('/Cart/ReceiveQrData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token
            },
            body: JSON.stringify({ qrData: qrValue })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success" && data.redirectUrl) {
                // ✅ التوجيه اليدوي إلى الصفحة الجديدة
                window.location.href = data.redirectUrl;
            } else {
                document.getElementById("response").innerText = "❌ " + (data.message || "حدث خطأ.");
            }
        })
        .catch(error => {
            document.getElementById("response").innerText = "❌ فشل الاتصال بالخادم.";
            console.error(error);
        });
    });

</script>
